# DVRPi BLE Leak Challenge Write-Up

## Overview
**Challenge Name**: DVRPi BLE Leak  
**Difficulty**: Intermediate  
**Category**: Wireless/Bluetooth  
**Goal**: Capture a flag advertised via Bluetooth Low Energy (BLE) by analyzing packets broadcast from a Raspberry Pi.

## What You’ll Need
- Raspberry Pi 4B with BLE capabilities (MAC `D8:3A:DD:49:05:CE`).
- Linux system with BlueZ (`hcitool`, `hciconfig`, `btmon`).
- Ubertooth One for external sniffing (optional).
- Wireshark for packet analysis.
- Wi-Fi client (SSID: `DVRPI`, password: `dvrpiconnect`).
- Terminal emulator for SSH or UART access.

## Challenge Description
A Raspberry Pi advertises a flag via BLE, embedded in the advertisement packet. The provided script (`dvrpi_ble_leak.py`) and configuration file (`dvrpi_ble_leak.conf`) attempt to broadcast the flag in the Manufacturer Specific Data field (ID `0xFFFF`). The goal is to capture and decode the flag by sniffing BLE packets, overcoming issues like malformed packets and missing traffic.

## How to Solve It
1. **Connect to Pi**:
   - Join Wi-Fi: SSID `DVRPI`, password `dvrpiconnect`.
   - Connect via SSH: `ssh root@192.168.4.1` or UART (GPIO 4: RX, 6: Ground, 8: TX; 115200 baud) with `minicom -D /dev/ttyUSB0 -b 115200`.

2. **Inspect Provided Files**:
   - Check configuration:
     ```bash
     cat /usr/local/share/xml/misc/misc/exploit/security/ble/share/.ble_flag.conf
     # [BLE]
     # flag = flag{DVRPi_BLE:EXPLORE}
     ```
   - Review script: `dvrpi_ble_leak.py` uses `hcitool` to advertise the flag.

3. **Run the Script**:
   - Reset Bluetooth adapter:
     ```bash
     sudo hciconfig hci0 reset
     sudo hciconfig hci0 up
     ```
   - Execute:
     ```bash
     sudo python3 dvrpi_ble_leak.py
     ```
   - Note: Initial runs showed no traffic in `btmon` and a "malformed packet: btcommon" error.

4. **Manually Send Advertisement**:
   - Due to script issues, manually configure the advertisement with a 128-bit UUID (`flag{DVRPi_BLE:E`, first 16 bytes of the flag) in the Incomplete List of Service Class UUIDs:
     ```bash
     sudo hciconfig hci0 reset
     sudo hciconfig hci0 up
     sudo hciconfig hci0 piscan
     sudo hciconfig hci0 leadv 0
     sudo hcitool -i hci0 cmd 0x08 0x0008 02 01 06 11 02 66 6c 61 67 7b 44 56 52 50 69 5f 42 4c 45 3a 45
     sudo hcitool -i hci0 cmd 0x08 0x000A 01
     ```

5. **Capture and Decode Flag**:
   - Use `btmon` to sniff packets:
     ```bash
     sudo hcitool lescan
     sudo btmon | grep -A 5 "Incomplete List of 128-bit Service UUIDs"
     ```
     Output:
     ```
     Incomplete List of 128-bit Service UUIDs: 666c61677b44565250695f424c453a45
     ```
     Convert:
     ```bash
     echo "666c61677b44565250695f424c453a45" | xxd -r -p
     # flag{DVRPi_BLE:E
     ```
   - Infer the full flag as `flag{DVRPi_BLE:EXPLORE}` based on the configuration file.

6. **Verify Full Flag**:
   - Test the original Manufacturer Data packet:
     ```bash
     sudo hcitool -i hci0 cmd 0x08 0x0008 02 01 06 18 FF FF FF 66 6c 61 67 7b 44 56 52 50 69 5f 42 4c 45 3a 45 58 50 4c 4f 52 45 7d
     sudo hcitool -i hci0 cmd 0x08 0x000A 01
     ```
   - Capture with `btmon`:
     ```bash
     sudo btmon | grep -A 5 "Manufacturer Specific Data: ID 0xFFFF"
     ```
     Output:
     ```
     Data: 666c61677b44565250695f424c453a4558504c4f52457d
     ```
     Convert:
     ```bash
     echo "666c61677b44565250695f424c453a4558504c4f52457d" | xxd -r -p
     # flag{DVRPi_BLE:EXPLORE}
     ```

## What You Learn
- BLE advertisement packet structure and configuration.
- Debugging malformed BLE packets using `hcitool` and `btmon`.
- Sniffing BLE traffic with `btmon` and Ubertooth One/Wireshark.
- Handling Bluetooth adapter states and BlueZ quirks.

## Notes
- **Adapter Issues**: Reset the adapter (`hciconfig hci0 reset`) if `EBUSY` or no traffic occurs.
- **BlueZ Version**: Ensure `hcitool` is supported (BlueZ ≤5.50). Check with `bluetoothctl --version`.
- **Ubertooth One**: Cycle channels (`-q 37`, `-q 38`, `-q 39`) if packets are missed.
- **Malformed Packet**: Caused by incorrect length fields in the script’s `adv_data`. Manual commands with precise lengths resolved this.
- **Alternative Tools**: `nRF Connect` mobile app can verify advertisements.

**Flag**: `flag{DVRPi_BLE:EXPLORE}`