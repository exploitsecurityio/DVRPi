# OTG-1 USB Misconfiguration (Low)

## Challenge Overview
- **Name**: OTG-1 USB Misconfiguration
- **Category**: Hardware / Embedded Systems
- **Difficulty**: Low
- **Objective**: Identify and exploit a USB misconfiguration on the Damn Vulnerable Raspberry Pi (DVRPi) to retrieve a hidden flag stored on a USB flash drive.
- **Tools Needed**:
  - FAT32-formatted USB flash drive
  - Computer with SSH access to DVRPi
  - Python 3 (for deobfuscation)
  - Web browser or `curl` (for flag submission)

The OTG-1 challenge simulates a common hardware vulnerability where a USB drive is automatically mounted without proper access controls, exposing sensitive data. Your task is to insert a USB drive, locate the obfuscated flag file, deobfuscate it, and submit the flag to the DVRPi dashboard.

## Prerequisites
- **DVRPi Setup**: Ensure your DVRPi is powered on and accessible via SSH over the `DVRPi_Hotspot` Wi-Fi or USB tethering (`usb0` interface).
- **USB Drive**: Prepare a USB flash drive formatted with a FAT32 filesystem.
- **SSH Access**: Use credentials provided in the DVRPi documentation (e.g., `root@dvrpi` with the default password).
- **Dashboard Access**: The Flask dashboard runs at `http://127.0.0.1:5150` (use SSH port forwarding if accessing remotely).

## Step-by-Step Solution

### Step 1: Prepare the USB Drive
1. Format a USB flash drive as FAT32 on your computer:
   - On Linux:
     ```bash
     sudo mkfs.vfat -F 32 /dev/sdX1
     ```
     Replace `/dev/sdX1` with your USB drive’s partition (use `lsblk` to identify it).
   - On Windows: Use Disk Management or `diskpart` to format as FAT32.
   - On macOS: Use Disk Utility to format as MS-DOS (FAT).

2. Safely eject the USB drive to ensure no filesystem errors.

### Step 2: Insert the USB Drive
1. Connect to the DVRPi via SSH:
   ```bash
   ssh root@<dvrpi-ip>
   ```
   Use the IP address from the `DVRPi_Hotspot` (e.g., `192.168.4.1`) or USB tethering interface.

2. Insert the FAT32 USB drive into one of the DVRPi’s USB-A ports.

3. Verify the USB drive is detected and mounted:
   ```bash
   lsblk
   ```
   Look for a device like `/dev/sda1` mounted at `/mnt/usb`. The DVRPi’s `udev` rules automatically mount FAT32 USB drives to `/mnt/usb`.

   If not mounted, check logs for errors:
   ```bash
   cat /var/log/syslog | grep -E "OTG-1|udev|mount"
   ```

### Step 3: Locate the Flag File
1. List the contents of the mounted USB drive:
   ```bash
   ls /mnt/usb
   ```
   You should see a file named `otg_flag.bin`.

2. Inspect the file:
   ```bash
   hexdump -C /mnt/usb/otg_flag.bin
   ```
   Output:
   ```
   00000000  33 39 34 32 2e 11 03 07  05 3c 0a 1a 01 12 0a 10  |3942.....<......|
   00000010  0d 05 1a 06 10 11                                 |......|
   ```
   The file contains obfuscated data, suggesting it needs to be deobfuscated.

### Step 4: Deobfuscate the Flag
1. Copy the flag file to the root directory for processing:
   ```bash
   cp /mnt/usb/otg_flag.bin /root/
   ```

2. Run the provided deobfuscation script:
   ```bash
   python3 /root/deobfuscate_otg_flag.py
   ```
   Output:
   ```
   The resulting flag: flag{DVRPi_OTG_EXPOSED}
   ```
   The script XORs each byte in `otg_flag.bin` with the key `0x55`, revealing the ASCII flag.

   If the script fails (e.g., “File not found”), ensure `otg_flag.bin` is in `/root/` and retry.

### Step 5: Submit the Flag
1. Submit the flag to the Flask dashboard using `curl`:
   ```bash
   curl -X POST -d "flag=flag{DVRPi_OTG_EXPOSED}" http://127.0.0.1:5150/submit
   ```
   If successful, the dashboard confirms the flag is correct.

2. Alternatively, access the dashboard via a browser:
   - Use SSH port forwarding:
     ```bash
     ssh -L 5150:127.0.0.1:5150 root@<dvrpi-ip>
     ```
   - Open `http://localhost:5150` in your browser, enter `flag{DVRPi_OTG_EXPOSED}`, and submit.

## How It Works
The OTG-1 challenge exploits a USB misconfiguration where the DVRPi automatically mounts any FAT32 USB drive to `/mnt/usb` without authentication. A `udev` rule triggers the `dvrpi-usb-flag@.service` upon USB insertion, running `/usr/bin/otg_setup.sh` to write the obfuscated `otg_flag.bin`. Additionally, the `dvrpi-usb-writer.service` runs every 5 seconds, ensuring `otg_flag.bin` is continuously written to `/mnt/usb` if mounted. The flag is obfuscated with a simple XOR (key `0x55`), which the provided Python script reverses. This setup mimics real-world USB vulnerabilities where sensitive data is exposed due to improper access controls.

## Debugging Tips
- **USB Not Detected**:
  - Check USB detection:
    ```bash
    lsusb; dmesg | grep usb; lsblk
    ```
  - Try a different USB drive or port. Persistent issues may indicate hardware damage (e.g., faulty USB-A ports).
- **Flag File Missing**:
  - Verify the writer service:
    ```bash
    systemctl status dvrpi-usb-writer.service
    ```
  - Check logs:
    ```bash
    cat /var/log/syslog | grep OTG-1-Writer
    ```
  - Ensure `/mnt/usb` is mounted and FAT32-formatted.
- **Service Failure**:
  - Check the USB flag service:
    ```bash
    systemctl status dvrpi-usb-flag@sda1.service
    ```
  - Review logs for errors:
    ```bash
    journalctl -u dvrpi-usb-flag@sda1.service
    ```
- **Dashboard Issues**:
  - Verify the Flask server:
    ```bash
    curl http://127.0.0.1:5150
    ```
  - Use port forwarding if accessing remotely.

## Lessons Learned
- **USB Auto-Mount Risks**: Automatically mounting USB drives without validation can expose sensitive data.
- **Obfuscation Weaknesses**: Simple XOR obfuscation is easily reversible, especially with access to the deobfuscation script.
- **Hardware Security**: Misconfigured hardware interfaces (e.g., USB ports) can lead to unauthorized access.
- **System Monitoring**: Logs and service statuses are critical for diagnosing hardware and software issues.

## Additional Notes
- The `dvrpi-usb-writer.service` ensures the flag is rewritten every 5 seconds, making the challenge robust against transient mount issues.
- If USB ports are unresponsive, test with a new Raspberry Pi, as GPIO issues (e.g., pins 18, 16, 20 reading ~0V) suggest potential hardware damage.
- Explore other DVRPi challenges (e.g., Unsecured UART Console, Glitch Attack, U-BOOT Environment Variable READ) for a comprehensive learning experience.

Congratulations on solving the OTG-1 USB Misconfiguration challenge! Submit your flag and move on to the next vulnerability!
