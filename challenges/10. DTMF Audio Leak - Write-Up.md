## Challenge Details

- **Name:** DTMF Audio Leak Challenge
- **Difficulty:** Low
- **Objective:** Decode a 16-digit PIN from DTMF tones output by the Raspberry Pi 4B and use it to unlock a secure program to retrieve a hidden flag.
- **Tools Needed:**
  - Smartphone or audio recording device (e.g., built-in voice recorder, free).
  - Audacity audio analysis software (free, available for Windows, macOS, Linux).
  - Speaker or headphones (connected to the Pi’s 3.5mm TRRS jack).
  - Raspberry Pi 4B (with SD card).

- **Prerequisites:**
  - Basic understanding of audio analysis (e.g., spectrograms).
  - Familiarity with DTMF tones and frequency mapping.
  - Basic Linux command-line knowledge.

- **Location in Firmware:** The DTMF tones are output via a systemd service (`dtmf.service`) playing a WAV file (`/usr/local/bin/dtmf.wav`) through the Pi’s 3.5mm TRRS audio jack. The secure program (`verify`) is located at `/home/pi/dtmf/verify`.

## Background

**DTMF (Dual-Tone Multi-Frequency)** is a signaling system used in telephony, where each digit (0–9) is represented by a unique pair of frequencies (low: 697 Hz, 770 Hz, 852 Hz, 941 Hz; high: 1209 Hz, 1336 Hz, 1477 Hz, 1633 Hz). In this challenge, the DVRPi firmware outputs a 16-digit PIN as DTMF tones through the audio jack, simulating a scenario where sensitive data is inadvertently leaked via audio signals, a vulnerability seen in some IoT devices or legacy systems.

The DVRPi firmware runs a systemd service that plays a WAV file containing the DTMF tones every 10 seconds. Participants must record the audio, analyze it using Audacity to decode the PIN, and input it into a secure program (`verify`) to retrieve a flag. This challenge mimics real-world audio-based data leaks, such as those in misconfigured VoIP systems or smart devices.

## Setup Instructions

Before starting, ensure the DVRPi firmware is flashed to an SD card and the Raspberry Pi 4B is powered on. Follow these steps to set up your hardware and software:

1. **Connect a Speaker:**
   - Attach a speaker or headphones to the Pi’s 3.5mm TRRS audio jack (GPIO pin 4 for audio output).
   - Ensure the speaker is amplified, as the Pi’s output is line-level.
   - Test audio output:
     ```bash
     aplay -l
     aplay /usr/share/sounds/alsa/Front_Center.wav
     ```

2. **Prepare a Recording Device:**
   - Use a smartphone with a voice recorder app (e.g., Voice Memos on iOS, Recorder on Android).
   - Alternatively, use a computer with a microphone or a digital voice recorder.

3. **Install Audacity:**
   - Download Audacity from [audacityteam.org](https://www.audacityteam.org/) for Windows, macOS, or Linux.
   - On Linux (e.g., Raspberry Pi OS):
     ```bash
     sudo apt update
     sudo apt install -y audacity
     ```
   - Verify Audacity launches correctly.

4. **Power On the Pi:**
   - Insert the SD card with the DVRPi firmware.
   - Power on the Pi using a USB-C power supply.
   - Check the `dtmf` service:
     ```bash
     systemctl status dtmf.timer
     ```

## Exploitation Steps

Follow these steps to decode the DTMF tones and retrieve the flag:

1. **Record the DTMF Tones:**
   - Position the smartphone’s microphone 1–2 inches from the speaker connected to the Pi’s 3.5mm TRRS jack.
   - Start recording in a quiet environment to minimize noise.
   - Record for at least 20 seconds to capture at least one full cycle of the DTMF tones (~9.6s per cycle, repeated every 10 seconds).
   - Save the recording as a WAV or MP3 file (e.g., `dtmf_recording.wav`).

2. **Analyze the Audio in Audacity:**
   - Open Audacity and import the recording:
     ```bash
     File > Import > Audio, select dtmf_recording.wav
     ```
   - Trim to one cycle (~9.6s) using the selection tool and Edit > Remove Special > Trim Audio.
   - Switch to spectrogram view:
     - Track dropdown > Spectrogram.
     - Edit > Preferences > Spectrogram:
       - Min Frequency: 600 Hz
       - Max Frequency: 1700 Hz
       - Scale: Linear
       - Colors: Grayscale
   - Identify 16 tones (~0.5s each, ~0.1s pauses), each with two frequency peaks (e.g., 697 Hz + 1209 Hz).
   - Map frequencies to digits using the DTMF chart:
     | Digit | Low Freq (Hz) | High Freq (Hz) |
     |-------|---------------|----------------|
     | 0     | 941           | 1336           |
     | 1     | 697           | 1209           |
     | 2     | 697           | 1336           |
     | 3     | 697           | 1477           |
     | 4     | 770           | 1209           |
     | 5     | 770           | 1336           |
     | 6     | 770           | 1477           |
     | 7     | 852           | 1209           |
     | 8     | 852           | 1336           |
     | 9     | 852           | 1477           |
   - Example: Peaks at 697 Hz + 1209 Hz = “1”.
   - Decode the 16-digit PIN (e.g., "1234567890123456").

3. **Run the Secure Program:**
   - Execute the `verify` binary:
     ```bash
     /home/pi/dtmf/verify
     ```
   - Observe the "DVRPi" banner:
     ```
     ____  _____ ____  ____  _
    |  _ \| ____|  _ \|  _ \| |
    | | | |  _| | |_) | |_) | |
    | |_| | |___|  _ <|  __/|_|
    |____/|_____|_| \_\_|   (_)
    Welcome to the DVRPi Leak Challenge!
    Decode the 16-digit PIN to reveal the flag.
    Press Ctrl+C to exit.
     ```
   - Enter the decoded PIN at the prompt (“Enter the 16-digit PIN (or Ctrl+C to exit):”).
   - The program validates:
     - Exactly 16 numeric digits.
     - Matches the SHA-256 hash of the PIN.
   - If correct, see `flag{DVRPi:DTMF-UNLOCKED}` and exit. If incorrect, retry or exit with Ctrl+C.

4. **Exit the Program:**
   - On incorrect PIN, the program loops, prompting again.
   - To exit, press Ctrl+C, which displays “Exiting DVRPi Leak Challenge.”

## Technical Details

1. **Firmware Configuration:**
   - The DTMF tones are stored in `/usr/local/bin/dtmf.wav`, a WAV file with 16 tones (0.5s each, 0.1s pauses, ~9.6s total) for the PIN "1234567890123456".
   - A systemd service (`dtmf.service`) plays the WAV file every 10 seconds:
     ```bash
     cat /etc/systemd/system/dtmf.service
     [Unit]
     Description=DTMF Tone Output Service
     After=network.target

     [Service]
     ExecStart=/home/pi/dtmf/dtmf
     WorkingDirectory=/home/pi/dtmf
     StandardOutput=journal
     StandardError=journal
     Restart=always
     User=pi

     [Install]
     WantedBy=multi-user.target
     ```
     ```bash
     cat /etc/systemd/system/dtmf.timer
     [Unit]
     Description=Run DTMF Tone Output Every 10 Seconds

     [Timer]
     OnBootSec=10
     OnUnitActiveSec=10
     Unit=dtmf.service

     [Install]
     WantedBy=timers.target
     ```
   - The secure program (`/home/pi/dtmf/verify`) uses a SHA-256 hash of the PIN for verification, compiled with PyInstaller for obfuscation.

2. **Why Vulnerable:**
   - The DTMF tones are output continuously without authentication, simulating an audio-based data leak.
   - Audio signals can be intercepted with minimal equipment (e.g., a smartphone), a common issue in misconfigured IoT devices or telephony systems.

3. **Real-World Relevance:**
   - DTMF leaks have been exploited in VoIP systems to capture sensitive data (e.g., PINs, passwords) [source: SANS Institute, 2023].
   - Smart devices with audio output (e.g., smart speakers) may inadvertently leak data via tones if not properly secured.

## Mitigation Strategies

To prevent this vulnerability in production systems:

1. **Disable Audio Output:**
   - Disable the 3.5mm TRRS audio jack unless required:
     ```bash
     sudo nano /boot/config.txt
     dtparam=audio=off
     ```

2. **Secure Sensitive Data:**
   - Avoid outputting sensitive data (e.g., PINs) as audio signals.
   - Use encrypted communication channels for data transmission.

3. **Implement Authentication:**
   - Require authentication before accessing sensitive outputs or programs.
   - Example: Add a password prompt to the `verify` program.

4. **Monitor Audio Interfaces:**
   - Detect and log unauthorized audio output attempts (requires custom monitoring software).

5. **Physical Security:**
   - Restrict access to the device’s audio jack using enclosures or tamper-evident seals.

## Resources
- **DVRPi Documentation**: `challenges/DTMF Audio Leak Challenge (Low).md`.
- **DTMF Frequency Chart**: [dcode.fr/dtmf-code](https://www.dcode.fr/dtmf-code).
- **Audacity Guide**: [audacityteam.org](https://www.audacityteam.org/).
- **Online DTMF Decoder**: [dtmf.netlify.app](https://dtmf.netlify.app/), [dialabc.com](http://dialabc.com/sound/detect/).

---

**Author**: [Exploit Security Team](https://www.exploitsecurity.io)  
**License**: GPL V3.0  
**Repository**: [DVRPi GitHub](https://github.com/exploitsecurityio/DVRPi)  
**Last Updated**: June 2, 2025